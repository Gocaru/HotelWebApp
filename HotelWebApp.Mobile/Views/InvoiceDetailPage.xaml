<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:HotelWebApp.Mobile.ViewModels"
             xmlns:models="clr-namespace:HotelWebApp.Mobile.Models"
             x:Class="HotelWebApp.Mobile.Views.InvoiceDetailPage"
             x:DataType="viewmodels:InvoiceDetailViewModel"
             Shell.NavBarIsVisible="True"
             Title="Invoice Details"
             BackgroundColor="{AppThemeBinding Light=White, Dark=#121212}">

    <ScrollView>
        <VerticalStackLayout Spacing="0">

            <!-- HERO SECTION WITH IMAGE BACKGROUND -->
            <Grid RowDefinitions="200">
                <!-- Background Image -->
                <Image Source="hotel_lobby.jpg"
                       Aspect="AspectFill"/>

                <!-- White Overlay -->
                <BoxView BackgroundColor="White"
                         Opacity="0.70"/>

                <!-- Content -->
                <VerticalStackLayout VerticalOptions="Center" 
                                     Spacing="10"
                                     Padding="40,0"
                                     IsVisible="{Binding Invoice, Converter={StaticResource ObjectNotNullConverter}}">

                    <Label Text="{Binding Invoice.Id, StringFormat='Invoice #{0}'}"
                           FontSize="28"
                           FontAttributes="Bold"
                           TextColor="#1E3A8A"
                           HorizontalTextAlignment="Center"
                           LineHeight="1.2"/>

                    <Label Text="{Binding Invoice.InvoiceDateFormatted}"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="#6B7280"
                           HorizontalTextAlignment="Center"/>

                </VerticalStackLayout>
            </Grid>

            <!-- CONTENT -->
            <VerticalStackLayout Padding="40,30"
                                 Spacing="25">

                <!-- Loading Indicator -->
                <ActivityIndicator IsRunning="{Binding IsBusy}"
                                   IsVisible="{Binding IsBusy}"
                                   Color="#1E3A8A"
                                   HeightRequest="50"/>

                <!-- Error Message -->
                <Frame IsVisible="{Binding ErrorMessage, Converter={StaticResource StringNotEmptyConverter}}"
                       BackgroundColor="#FEE2E2"
                       BorderColor="#EF4444"
                       CornerRadius="12"
                       Padding="20"
                       HasShadow="False">
                    <Label Text="{Binding ErrorMessage}"
                           TextColor="#991B1B"
                           FontSize="14"
                           LineHeight="1.5"/>
                </Frame>

                <!-- Invoice Content -->
                <VerticalStackLayout IsVisible="{Binding Invoice, Converter={StaticResource ObjectNotNullConverter}}"
                                     Spacing="30">

                    <!-- Status and Room -->
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0"
                               Text="{Binding Invoice.RoomNumber, StringFormat='Room {0}'}"
                               FontSize="22"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#1F2937, Dark=#E5E7EB}"
                               VerticalOptions="Center"/>

                        <Border Grid.Column="1"
                                StrokeThickness="0"
                                StrokeShape="RoundRectangle 8"
                                Padding="12,8"
                                BackgroundColor="{Binding Invoice.StatusColor}"
                                VerticalOptions="Center">
                            <Label Text="{Binding Invoice.StatusDisplayText}"
                                   TextColor="White"
                                   FontSize="13"
                                   FontAttributes="Bold"/>
                        </Border>
                    </Grid>

                    <!-- Dates -->
                    <HorizontalStackLayout Spacing="8"
                                           HorizontalOptions="Start">
                        <Label Text="{Binding Invoice.CheckInFormatted}"
                               FontSize="15"
                               TextColor="{AppThemeBinding Light=#6B7280, Dark=#9CA3AF}"/>
                        <Label Text="→"
                               FontSize="15"
                               TextColor="{AppThemeBinding Light=#6B7280, Dark=#9CA3AF}"/>
                        <Label Text="{Binding Invoice.CheckOutFormatted}"
                               FontSize="15"
                               TextColor="{AppThemeBinding Light=#6B7280, Dark=#9CA3AF}"/>
                    </HorizontalStackLayout>

                    <!-- Financial Summary -->
                    <VerticalStackLayout Spacing="15">
                        <Label Text="Financial Summary"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#1E3A8A, Dark=#60A5FA}"/>

                        <Grid RowDefinitions="Auto,Auto,1,Auto"
                              RowSpacing="12">

                            <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                                <Label Grid.Column="0"
                                       Text="Total Amount"
                                       FontSize="15"
                                       TextColor="{AppThemeBinding Light=#6B7280, Dark=#9CA3AF}"
                                       VerticalOptions="Center"/>
                                <Label Grid.Column="1"
                                       Text="{Binding Invoice.TotalAmountFormatted}"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#1F2937, Dark=#E5E7EB}"
                                       VerticalOptions="Center"/>
                            </Grid>

                            <Grid Grid.Row="1" ColumnDefinitions="*,Auto">
                                <Label Grid.Column="0"
                                       Text="Amount Paid"
                                       FontSize="15"
                                       TextColor="{AppThemeBinding Light=#6B7280, Dark=#9CA3AF}"
                                       VerticalOptions="Center"/>
                                <Label Grid.Column="1"
                                       Text="{Binding Invoice.AmountPaidFormatted}"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="#10B981"
                                       VerticalOptions="Center"/>
                            </Grid>

                            <BoxView Grid.Row="2"
                                     HeightRequest="1"
                                     Color="{AppThemeBinding Light=#E5E7EB, Dark=#374151}"/>

                            <Grid Grid.Row="3" ColumnDefinitions="*,Auto">
                                <Label Grid.Column="0"
                                       Text="Balance Due"
                                       FontSize="17"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#1F2937, Dark=#E5E7EB}"
                                       VerticalOptions="Center"/>
                                <Label Grid.Column="1"
                                       Text="{Binding Invoice.BalanceDueFormatted}"
                                       FontSize="24"
                                       FontAttributes="Bold"
                                       TextColor="#EF4444"
                                       VerticalOptions="Center"/>
                            </Grid>
                        </Grid>
                    </VerticalStackLayout>

                    <!-- Invoice Items -->
                    <VerticalStackLayout Spacing="15"
                                         IsVisible="{Binding Items.Count, Converter={StaticResource IntToBoolConverter}}">
                        <Label Text="Invoice Items"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#1E3A8A, Dark=#60A5FA}"/>

                        <CollectionView ItemsSource="{Binding Items}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:InvoiceItemDto">
                                    <Border StrokeThickness="1"
                                            Stroke="{AppThemeBinding Light=#E5E7EB, Dark=#374151}"
                                            StrokeShape="RoundRectangle 10"
                                            Padding="16"
                                            Margin="0,0,0,10"
                                            BackgroundColor="{AppThemeBinding Light=#F9FAFB, Dark=#1F2937}">
                                        <Grid ColumnDefinitions="*,Auto"
                                              ColumnSpacing="12">
                                            <VerticalStackLayout Grid.Column="0" Spacing="4">
                                                <Label Text="{Binding Description}"
                                                       FontSize="15"
                                                       FontAttributes="Bold"
                                                       TextColor="{AppThemeBinding Light=#1F2937, Dark=#E5E7EB}"/>
                                                <HorizontalStackLayout Spacing="4">
                                                    <Label Text="Qty:"
                                                           FontSize="13"
                                                           TextColor="{AppThemeBinding Light=#6B7280, Dark=#9CA3AF}"/>
                                                    <Label Text="{Binding Quantity}"
                                                           FontSize="13"
                                                           FontAttributes="Bold"
                                                           TextColor="{AppThemeBinding Light=#6B7280, Dark=#9CA3AF}"/>
                                                    <Label Text="×"
                                                           FontSize="13"
                                                           TextColor="{AppThemeBinding Light=#6B7280, Dark=#9CA3AF}"/>
                                                    <Label Text="{Binding UnitPriceFormatted}"
                                                           FontSize="13"
                                                           TextColor="{AppThemeBinding Light=#6B7280, Dark=#9CA3AF}"/>
                                                </HorizontalStackLayout>
                                            </VerticalStackLayout>
                                            <Label Grid.Column="1"
                                                   Text="{Binding TotalPriceFormatted}"
                                                   FontSize="18"
                                                   FontAttributes="Bold"
                                                   TextColor="{AppThemeBinding Light=#1E3A8A, Dark=#60A5FA}"
                                                   VerticalOptions="Center"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <!-- Amenities -->
                    <VerticalStackLayout Spacing="15"
                                         IsVisible="{Binding Invoice.ReservationAmenities.Count, Converter={StaticResource IntToBoolConverter}}">
                        <Label Text="Amenities"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#1E3A8A, Dark=#60A5FA}"/>

                        <CollectionView ItemsSource="{Binding Invoice.ReservationAmenities}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:ReservationAmenityDto">
                                    <Border StrokeThickness="1"
                                            Stroke="{AppThemeBinding Light=#E5E7EB, Dark=#374151}"
                                            StrokeShape="RoundRectangle 10"
                                            Padding="16"
                                            Margin="0,0,0,10"
                                            BackgroundColor="{AppThemeBinding Light=#F9FAFB, Dark=#1F2937}">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0"
                                                   Text="{Binding AmenityName}"
                                                   FontSize="15"
                                                   TextColor="{AppThemeBinding Light=#1F2937, Dark=#E5E7EB}"
                                                   VerticalOptions="Center"/>
                                            <Label Grid.Column="1"
                                                   Text="{Binding Price, StringFormat='€{0:N2}'}"
                                                   FontSize="18"
                                                   FontAttributes="Bold"
                                                   TextColor="{AppThemeBinding Light=#1E3A8A, Dark=#60A5FA}"
                                                   VerticalOptions="Center"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <!-- Payment History -->
                    <VerticalStackLayout Spacing="15"
                                         IsVisible="{Binding Invoice.Payments.Count, Converter={StaticResource IntToBoolConverter}}">
                        <Label Text="Payment History"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#1E3A8A, Dark=#60A5FA}"/>

                        <CollectionView ItemsSource="{Binding Invoice.Payments}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:PaymentDto">
                                    <Border StrokeThickness="2"
                                            Stroke="#86EFAC"
                                            StrokeShape="RoundRectangle 10"
                                            Padding="16"
                                            Margin="0,0,0,10"
                                            BackgroundColor="{AppThemeBinding Light=#F0FDF4, Dark=#064E3B}">
                                        <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="6">
                                            <Label Grid.Row="0"
                                                   Text="{Binding AmountFormatted}"
                                                   FontSize="20"
                                                   FontAttributes="Bold"
                                                   TextColor="#10B981"/>

                                            <Label Grid.Row="1"
                                                   Text="{Binding PaymentDateFormatted}"
                                                   FontSize="14"
                                                   TextColor="{AppThemeBinding Light=#6B7280, Dark=#9CA3AF}"/>

                                            <HorizontalStackLayout Grid.Row="2"
                                                                   Spacing="5">
                                                <Label Text="{Binding PaymentMethod}"
                                                       FontSize="13"
                                                       FontAttributes="Bold"
                                                       TextColor="{AppThemeBinding Light=#6B7280, Dark=#9CA3AF}"/>
                                                <Label Text="•"
                                                       FontSize="13"
                                                       TextColor="{AppThemeBinding Light=#6B7280, Dark=#9CA3AF}"
                                                       IsVisible="{Binding TransactionId, Converter={StaticResource StringNotEmptyConverter}}"/>
                                                <Label Text="{Binding TransactionId}"
                                                       FontSize="13"
                                                       TextColor="{AppThemeBinding Light=#6B7280, Dark=#9CA3AF}"
                                                       IsVisible="{Binding TransactionId, Converter={StaticResource StringNotEmptyConverter}}"/>
                                            </HorizontalStackLayout>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <!-- Action Buttons -->
                    <VerticalStackLayout Spacing="12" Margin="0,10,0,20">

                        <!-- Pay Invoice Button -->
                        <Border StrokeThickness="0"
                                StrokeShape="RoundRectangle 12"
                                Padding="0"
                                HeightRequest="56"
                                BackgroundColor="#1E3A8A"
                                IsVisible="{Binding Invoice.HasBalance}">
                            <Border.Shadow>
                                <Shadow Brush="Black" Opacity="0.1" Radius="8" Offset="0,2"/>
                            </Border.Shadow>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding PayInvoiceCommand}"/>
                            </Border.GestureRecognizers>
                            <Label Text="Pay Invoice"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="White"
                                   HorizontalTextAlignment="Center"
                                   VerticalTextAlignment="Center"/>
                        </Border>

                    </VerticalStackLayout>

                </VerticalStackLayout>

            </VerticalStackLayout>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>