<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:HotelWebApp.Mobile.ViewModels"
             xmlns:models="clr-namespace:HotelWebApp.Mobile.Models"
             x:Class="HotelWebApp.Mobile.Views.InvoiceDetailPage"
             x:DataType="viewmodels:InvoiceDetailViewModel"
             Shell.NavBarIsVisible="True"
             Title="Invoice Details"
             BackgroundColor="White">

    <ScrollView>
        <VerticalStackLayout Spacing="0">

            <!-- HERO HEADER -->
            <Grid RowDefinitions="140" Padding="0">
                <Grid.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                        <GradientStop Color="#1E3A8A" Offset="0.0" />
                        <GradientStop Color="#3B82F6" Offset="1.0" />
                    </LinearGradientBrush>
                </Grid.Background>

                <VerticalStackLayout VerticalOptions="Center" 
                                     Padding="20"
                                     Spacing="8"
                                     IsVisible="{Binding Invoice, Converter={StaticResource ObjectNotNullConverter}}">
                    <Label Text="{Binding Invoice.Id, StringFormat='Invoice #{0}'}"
                           FontSize="28"
                           FontAttributes="Bold"
                           TextColor="White"/>
                    <Label Text="{Binding Invoice.InvoiceDateFormatted}"
                           FontSize="14"
                           TextColor="White"
                           Opacity="0.9"/>
                </VerticalStackLayout>
            </Grid>

            <!-- CONTENT -->
            <VerticalStackLayout Padding="20" Spacing="15">

                <!-- Loading Indicator -->
                <ActivityIndicator IsRunning="{Binding IsBusy}"
                                   IsVisible="{Binding IsBusy}"
                                   Color="#1E3A8A"
                                   HeightRequest="50"
                                   Margin="0,20,0,0"/>

                <!-- Error Message -->
                <Frame IsVisible="{Binding ErrorMessage, Converter={StaticResource StringNotEmptyConverter}}"
                       BackgroundColor="#FEE2E2"
                       BorderColor="#EF4444"
                       CornerRadius="10"
                       Padding="15"
                       HasShadow="False">
                    <Label Text="{Binding ErrorMessage}"
                           TextColor="#991B1B"
                           FontSize="14"/>
                </Frame>

                <!-- Invoice Content -->
                <VerticalStackLayout IsVisible="{Binding Invoice, Converter={StaticResource ObjectNotNullConverter}}"
                                     Spacing="15">

                    <!-- Invoice Summary Card -->
                    <Frame CornerRadius="15" 
                           HasShadow="True" 
                           Padding="20" 
                           BorderColor="Transparent"
                           BackgroundColor="White">
                        <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="15">

                            <!-- Icon and Status -->
                            <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto">
                                <Frame Grid.Column="0"
                                       Padding="12"
                                       BackgroundColor="#FEF3C7"
                                       BorderColor="Transparent"
                                       CornerRadius="10"
                                       HasShadow="False">
                                    <Label Text="ðŸ’³"
                                           FontSize="24"/>
                                </Frame>

                                <Label Grid.Column="1"
                                       Text="{Binding Invoice.RoomNumber, StringFormat='Room {0}'}"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="#1F2937"
                                       VerticalOptions="Center"
                                       Margin="12,0,0,0"/>

                                <Frame Grid.Column="2"
                                       Padding="8,4"
                                       CornerRadius="5"
                                       BackgroundColor="{Binding Invoice.StatusColor}"
                                       HasShadow="False"
                                       VerticalOptions="Center">
                                    <Label Text="{Binding Invoice.StatusDisplayText}"
                                           TextColor="White"
                                           FontSize="10"
                                           FontAttributes="Bold"/>
                                </Frame>
                            </Grid>

                            <!-- Dates -->
                            <Frame Grid.Row="1"
                                   Padding="12"
                                   BackgroundColor="#F9FAFB"
                                   BorderColor="Transparent"
                                   CornerRadius="8"
                                   HasShadow="False">
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="ðŸ¨"
                                           FontSize="14"
                                           VerticalOptions="Center"/>
                                    <Label Text="{Binding Invoice.CheckInFormatted}"
                                           FontSize="13"
                                           TextColor="#6B7280"
                                           VerticalOptions="Center"/>
                                    <Label Text="â†’"
                                           FontSize="13"
                                           TextColor="#6B7280"
                                           VerticalOptions="Center"/>
                                    <Label Text="{Binding Invoice.CheckOutFormatted}"
                                           FontSize="13"
                                           TextColor="#6B7280"
                                           VerticalOptions="Center"/>
                                </HorizontalStackLayout>
                            </Frame>

                            <!-- Financial Summary -->
                            <Grid Grid.Row="2"
                                  RowDefinitions="Auto,Auto,1,Auto"
                                  RowSpacing="10">

                                <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                                    <Label Grid.Column="0" 
                                           Text="Total Amount:" 
                                           FontSize="14"
                                           TextColor="#6B7280"/>
                                    <Label Grid.Column="1" 
                                           Text="{Binding Invoice.TotalAmountFormatted}" 
                                           FontSize="16" 
                                           FontAttributes="Bold"
                                           TextColor="#1F2937"/>
                                </Grid>

                                <Grid Grid.Row="1" ColumnDefinitions="*,Auto">
                                    <Label Grid.Column="0" 
                                           Text="Amount Paid:" 
                                           FontSize="14"
                                           TextColor="#6B7280"/>
                                    <Label Grid.Column="1" 
                                           Text="{Binding Invoice.AmountPaidFormatted}" 
                                           FontSize="16" 
                                           FontAttributes="Bold"
                                           TextColor="#10B981"/>
                                </Grid>

                                <BoxView Grid.Row="2" 
                                         HeightRequest="1" 
                                         Color="#E5E7EB"
                                         Margin="0,5"/>

                                <Grid Grid.Row="3" ColumnDefinitions="*,Auto">
                                    <Label Grid.Column="0" 
                                           Text="Balance Due:" 
                                           FontSize="16" 
                                           FontAttributes="Bold"
                                           TextColor="#1F2937"/>
                                    <Label Grid.Column="1" 
                                           Text="{Binding Invoice.BalanceDueFormatted}" 
                                           FontSize="20" 
                                           FontAttributes="Bold"
                                           TextColor="#EF4444"/>
                                </Grid>
                            </Grid>
                        </Grid>
                    </Frame>

                    <!-- Invoice Items Card -->
                    <Frame CornerRadius="15" 
                           HasShadow="True" 
                           Padding="20" 
                           BorderColor="Transparent"
                           BackgroundColor="White"
                           IsVisible="{Binding Items.Count, Converter={StaticResource IntToBoolConverter}}">
                        <VerticalStackLayout Spacing="15">
                            <HorizontalStackLayout Spacing="8">
                                <Label Text="ðŸ“‹"
                                       FontSize="20"
                                       VerticalOptions="Center"/>
                                <Label Text="Invoice Items" 
                                       FontSize="18" 
                                       FontAttributes="Bold"
                                       TextColor="#1F2937"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>

                            <CollectionView ItemsSource="{Binding Items}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:InvoiceItemDto">
                                        <Frame Padding="12"
                                               Margin="0,0,0,8"
                                               CornerRadius="8"
                                               BackgroundColor="#F9FAFB"
                                               HasShadow="False"
                                               BorderColor="Transparent">
                                            <Grid ColumnDefinitions="*,Auto" 
                                                  ColumnSpacing="10">
                                                <VerticalStackLayout Grid.Column="0" Spacing="4">
                                                    <Label Text="{Binding Description}" 
                                                           FontSize="14"
                                                           FontAttributes="Bold"
                                                           TextColor="#1F2937"/>
                                                    <HorizontalStackLayout Spacing="4">
                                                        <Label Text="Qty:" 
                                                               FontSize="12" 
                                                               TextColor="#6B7280"/>
                                                        <Label Text="{Binding Quantity}" 
                                                               FontSize="12" 
                                                               TextColor="#6B7280"
                                                               FontAttributes="Bold"/>
                                                        <Label Text="Ã—" 
                                                               FontSize="12" 
                                                               TextColor="#6B7280"/>
                                                        <Label Text="{Binding UnitPriceFormatted}" 
                                                               FontSize="12" 
                                                               TextColor="#6B7280"/>
                                                    </HorizontalStackLayout>
                                                </VerticalStackLayout>
                                                <Label Grid.Column="1"
                                                       Text="{Binding TotalPriceFormatted}" 
                                                       FontSize="16" 
                                                       FontAttributes="Bold"
                                                       TextColor="#1E3A8A"
                                                       VerticalOptions="Center"/>
                                            </Grid>
                                        </Frame>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Amenities Card -->
                    <Frame CornerRadius="15" 
                           HasShadow="True" 
                           Padding="20" 
                           BorderColor="Transparent"
                           BackgroundColor="White"
                           IsVisible="{Binding Invoice.ReservationAmenities.Count, Converter={StaticResource IntToBoolConverter}}">
                        <VerticalStackLayout Spacing="15">
                            <HorizontalStackLayout Spacing="8">
                                <Label Text="âœ¨"
                                       FontSize="20"
                                       VerticalOptions="Center"/>
                                <Label Text="Amenities" 
                                       FontSize="18" 
                                       FontAttributes="Bold"
                                       TextColor="#1F2937"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>

                            <CollectionView ItemsSource="{Binding Invoice.ReservationAmenities}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:ReservationAmenityDto">
                                        <Frame Padding="12"
                                               Margin="0,0,0,8"
                                               CornerRadius="8"
                                               BackgroundColor="#F9FAFB"
                                               HasShadow="False"
                                               BorderColor="Transparent">
                                            <Grid ColumnDefinitions="*,Auto" 
                                                  ColumnSpacing="10">
                                                <Label Grid.Column="0"
                                                       Text="{Binding AmenityName}" 
                                                       FontSize="14"
                                                       TextColor="#1F2937"
                                                       VerticalOptions="Center"/>
                                                <Label Grid.Column="1"
                                                       Text="{Binding Price, StringFormat='â‚¬{0:N2}'}" 
                                                       FontSize="16" 
                                                       FontAttributes="Bold"
                                                       TextColor="#1E3A8A"
                                                       VerticalOptions="Center"/>
                                            </Grid>
                                        </Frame>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Payment History Card -->
                    <Frame CornerRadius="15" 
                           HasShadow="True" 
                           Padding="20" 
                           BorderColor="Transparent"
                           BackgroundColor="White"
                           IsVisible="{Binding Invoice.Payments.Count, Converter={StaticResource IntToBoolConverter}}">
                        <VerticalStackLayout Spacing="15">
                            <HorizontalStackLayout Spacing="8">
                                <Label Text="ðŸ’³"
                                       FontSize="20"
                                       VerticalOptions="Center"/>
                                <Label Text="Payment History" 
                                       FontSize="18" 
                                       FontAttributes="Bold"
                                       TextColor="#1F2937"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>

                            <CollectionView ItemsSource="{Binding Invoice.Payments}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:PaymentDto">
                                        <Frame Padding="15" 
                                               Margin="0,0,0,8"
                                               CornerRadius="10"
                                               BackgroundColor="#F0FDF4"
                                               HasShadow="False"
                                               BorderColor="#86EFAC">
                                            <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="6">
                                                <HorizontalStackLayout Grid.Row="0" Spacing="10">
                                                    <Label Text="âœ…" 
                                                           FontSize="18"
                                                           VerticalOptions="Center"/>
                                                    <Label Text="{Binding AmountFormatted}" 
                                                           FontSize="18" 
                                                           FontAttributes="Bold"
                                                           TextColor="#10B981"
                                                           VerticalOptions="Center"/>
                                                </HorizontalStackLayout>

                                                <Label Grid.Row="1"
                                                       Text="{Binding PaymentDateFormatted}" 
                                                       FontSize="13" 
                                                       TextColor="#6B7280"
                                                       Margin="28,0,0,0"/>

                                                <HorizontalStackLayout Grid.Row="2" 
                                                                       Spacing="5"
                                                                       Margin="28,0,0,0">
                                                    <Label Text="{Binding PaymentMethod}" 
                                                           FontSize="12" 
                                                           TextColor="#6B7280"
                                                           FontAttributes="Bold"/>
                                                    <Label Text="â€¢" 
                                                           FontSize="12" 
                                                           TextColor="#6B7280"
                                                           IsVisible="{Binding TransactionId, Converter={StaticResource StringNotEmptyConverter}}"/>
                                                    <Label Text="{Binding TransactionId}" 
                                                           FontSize="12" 
                                                           TextColor="#6B7280"
                                                           IsVisible="{Binding TransactionId, Converter={StaticResource StringNotEmptyConverter}}"/>
                                                </HorizontalStackLayout>
                                            </Grid>
                                        </Frame>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Action Buttons -->
                    <VerticalStackLayout Spacing="10" Margin="0,10,0,20">
                        <Button Text="ðŸ’³ Pay Invoice"
                                Command="{Binding PayInvoiceCommand}"
                                IsVisible="{Binding Invoice.HasBalance}"
                                BackgroundColor="#1E3A8A"
                                TextColor="White"
                                FontSize="16"
                                FontAttributes="Bold"
                                HeightRequest="50"
                                CornerRadius="10"/>

                        <Button Text="ðŸ”„ Refresh"
                                Command="{Binding RefreshCommand}"
                                BackgroundColor="#6B7280"
                                TextColor="White"
                                FontSize="14"
                                HeightRequest="45"
                                CornerRadius="10"/>
                    </VerticalStackLayout>

                </VerticalStackLayout>

            </VerticalStackLayout>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>