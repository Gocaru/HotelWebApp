<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:HotelWebApp.Mobile.ViewModels"
             xmlns:converters="clr-namespace:HotelWebApp.Mobile.Converters"
             x:Class="HotelWebApp.Mobile.Views.ProfilePage"
             x:DataType="vm:ProfileViewModel"
             Title="My Profile">

    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!-- Loading Indicator -->
            <ActivityIndicator IsRunning="{Binding IsBusy}"
                             IsVisible="{Binding IsBusy}"
                             Color="{StaticResource Primary}"
                             VerticalOptions="Center"
                             HeightRequest="50" />

            <!-- Profile Content -->
            <VerticalStackLayout IsVisible="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                               Spacing="20">

                <!-- Profile Photo Section -->
                <Frame CornerRadius="15"
                       Padding="0"
                       HasShadow="True"
                       BorderColor="Transparent"
                       BackgroundColor="{AppThemeBinding Light=White, Dark=#1F1F1F}">
                    <VerticalStackLayout Padding="20" Spacing="15">

                        <!-- Photo with tap gesture -->
                        <Grid WidthRequest="120"
                              HeightRequest="120"
                              HorizontalOptions="Center">

                            <Frame CornerRadius="60"
                                   Padding="0"
                                   HasShadow="False"
                                   BorderColor="{StaticResource Primary}"
                                   WidthRequest="120"
                                   HeightRequest="120"
                                   IsClippedToBounds="True">
                                <Image Source="{Binding Profile.ProfileImageSource}"
                                       Aspect="AspectFill" />
                            </Frame>

                            <!-- Camera icon overlay -->
                            <Frame CornerRadius="20"
                                   Padding="8"
                                   HasShadow="True"
                                   BackgroundColor="{StaticResource Primary}"
                                   VerticalOptions="End"
                                   HorizontalOptions="End"
                                   WidthRequest="40"
                                   HeightRequest="40">
                                <Label Text="📷"
                                       FontSize="20"
                                       VerticalOptions="Center"
                                       HorizontalOptions="Center" />
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ChangePhotoCommand}" />
                                </Frame.GestureRecognizers>
                            </Frame>
                        </Grid>

                        <Label Text="{Binding Profile.FullName}"
                               FontSize="24"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#1F1F1F, Dark=White}"
                               HorizontalTextAlignment="Center" />

                        <Label Text="{Binding Profile.Email}"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                               HorizontalTextAlignment="Center" />
                    </VerticalStackLayout>
                </Frame>

                <!-- Statistics Cards -->
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10">
                    <!-- Total Reservations -->
                    <Frame Grid.Column="0"
                           CornerRadius="12"
                           Padding="15"
                           HasShadow="True"
                           BorderColor="Transparent"
                           BackgroundColor="{StaticResource Primary}">
                        <VerticalStackLayout Spacing="5">
                            <Label Text="{Binding Profile.TotalReservations}"
                                   FontSize="24"
                                   FontAttributes="Bold"
                                   TextColor="White"
                                   HorizontalTextAlignment="Center" />
                            <Label Text="All Stays"
                                   FontSize="11"
                                   TextColor="White"
                                   HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Completed Stays -->
                    <Frame Grid.Column="1"
                           CornerRadius="12"
                           Padding="15"
                           HasShadow="True"
                           BorderColor="Transparent"
                           BackgroundColor="#10B981">
                        <VerticalStackLayout Spacing="5">
                            <Label Text="{Binding Profile.CompletedStays}"
                                   FontSize="24"
                                   FontAttributes="Bold"
                                   TextColor="White"
                                   HorizontalTextAlignment="Center" />
                            <Label Text="Past Stays"
                                   FontSize="11"
                                   TextColor="White"
                                   HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Upcoming -->
                    <Frame Grid.Column="2"
                           CornerRadius="12"
                           Padding="15"
                           HasShadow="True"
                           BorderColor="Transparent"
                           BackgroundColor="#F59E0B">
                        <VerticalStackLayout Spacing="5">
                            <Label Text="{Binding Profile.UpcomingReservations}"
                                   FontSize="24"
                                   FontAttributes="Bold"
                                   TextColor="White"
                                   HorizontalTextAlignment="Center" />
                            <Label Text="Upcoming"
                                   FontSize="11"
                                   TextColor="White"
                                   HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                    </Frame>
                </Grid>

                <!-- Personal Information -->
                <Frame CornerRadius="15"
                       Padding="20"
                       HasShadow="True"
                       BorderColor="Transparent"
                       BackgroundColor="{AppThemeBinding Light=White, Dark=#1F1F1F}">
                    <VerticalStackLayout Spacing="15">

                        <!-- Header with Edit Button -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0"
                                   Text="Personal Information"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light=#1F1F1F, Dark=White}" />

                            <!-- Edit Button (quando NÃO está a editar) -->
                            <Button Grid.Column="1"
                                    Text="Edit"
                                    Command="{Binding ToggleEditCommand}"
                                    BackgroundColor="Transparent"
                                    TextColor="{StaticResource Primary}"
                                    FontSize="14"
                                    Padding="10,0"
                                    IsVisible="{Binding IsEditing, Converter={StaticResource InvertedBoolConverter}}" />

                            <!-- Cancel Button (quando ESTÁ a editar) -->
                            <Button Grid.Column="1"
                                    Text="Cancel"
                                    Command="{Binding ToggleEditCommand}"
                                    BackgroundColor="Transparent"
                                    TextColor="#DC2626"
                                    FontSize="14"
                                    Padding="10,0"
                                    IsVisible="{Binding IsEditing}" />
                        </Grid>

                        <!-- View Mode -->
                        <VerticalStackLayout Spacing="15"
                                           IsVisible="{Binding IsEditing, Converter={StaticResource InvertedBoolConverter}}">

                            <VerticalStackLayout Spacing="5">
                                <Label Text="Full Name"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}" />
                                <Label Text="{Binding Profile.FullName}"
                                       FontSize="16"
                                       TextColor="{AppThemeBinding Light=#1F1F1F, Dark=White}" />
                            </VerticalStackLayout>

                            <VerticalStackLayout Spacing="5">
                                <Label Text="Phone Number"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}" />
                                <Label Text="{Binding Profile.DisplayPhoneNumber}"
                                       FontSize="16"
                                       TextColor="{AppThemeBinding Light=#1F1F1F, Dark=White}" />
                            </VerticalStackLayout>

                            <VerticalStackLayout Spacing="5">
                                <Label Text="Identification Document"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}" />
                                <Label Text="{Binding Profile.DisplayDocument}"
                                       FontSize="16"
                                       TextColor="{AppThemeBinding Light=#1F1F1F, Dark=White}" />
                            </VerticalStackLayout>
                        </VerticalStackLayout>

                        <!-- Edit Mode -->
                        <VerticalStackLayout Spacing="15"
                                           IsVisible="{Binding IsEditing}">

                            <VerticalStackLayout Spacing="5">
                                <Label Text="Full Name *"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}" />
                                <Entry Text="{Binding FullName}"
                                       Placeholder="Enter your full name"
                                       FontSize="16"
                                       TextColor="{AppThemeBinding Light=#1F1F1F, Dark=White}"
                                       BackgroundColor="{AppThemeBinding Light=#F9FAFB, Dark=#2D2D2D}" />
                            </VerticalStackLayout>

                            <VerticalStackLayout Spacing="5">
                                <Label Text="Phone Number"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}" />
                                <Entry Text="{Binding PhoneNumber}"
                                       Placeholder="Enter your phone number"
                                       Keyboard="Telephone"
                                       FontSize="16"
                                       TextColor="{AppThemeBinding Light=#1F1F1F, Dark=White}"
                                       BackgroundColor="{AppThemeBinding Light=#F9FAFB, Dark=#2D2D2D}" />
                            </VerticalStackLayout>

                            <VerticalStackLayout Spacing="5">
                                <Label Text="Identification Document"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}" />
                                <Entry Text="{Binding IdentificationDocument}"
                                       Placeholder="Enter document number"
                                       FontSize="16"
                                       TextColor="{AppThemeBinding Light=#1F1F1F, Dark=White}"
                                       BackgroundColor="{AppThemeBinding Light=#F9FAFB, Dark=#2D2D2D}" />
                            </VerticalStackLayout>

                            <!-- Save Button -->
                            <Button Text="Save Changes"
                                    Command="{Binding SaveProfileCommand}"
                                    BackgroundColor="{StaticResource Primary}"
                                    TextColor="White"
                                    CornerRadius="10"
                                    HeightRequest="50"
                                    FontAttributes="Bold" />
                        </VerticalStackLayout>

                    </VerticalStackLayout>
                </Frame>

                <!-- View All Reservations Button -->
                <Button Text="View All Reservations"
                        Command="{Binding ViewReservationsCommand}"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        CornerRadius="10"
                        HeightRequest="50"
                        FontAttributes="Bold" />

            </VerticalStackLayout>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>