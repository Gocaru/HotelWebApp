@model HotelWebApp.Data.Entities.Reservation

@{
    ViewData["Title"] = "Reservation Details";
}

<h1>Details</h1>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}

<div>
    <h4>Reservation Information</h4>
    <hr />
    <dl class="row">
        <dt class="col-sm-2">
            Guest
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.ApplicationUser.FullName)
        </dd>
        <dt class="col-sm-2">
            Room Number
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Room.RoomNumber)
        </dd>

        <dt class="col-sm-2">
            Number of Guests
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.NumberOfGuests)
        </dd>

        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.CheckInDate)
        </dt>
        <dd class="col-sm-10">
            @Model.CheckInDate.ToString("dd/MM/yyyy HH:mm")
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.CheckOutDate)
        </dt>
        <dd class="col-sm-10">
            @Model.CheckOutDate.ToString("dd/MM/yyyy HH:mm")
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.ReservationDate)
        </dt>
        <dd class="col-sm-10">
            @Model.ReservationDate.ToString("dd/MM/yyyy HH:mm:ss")
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.TotalPrice)
        </dt>
        <dd class="col-sm-10">
            @Model.TotalPrice.ToString("C")
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Status)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Status)
        </dd>
    </dl>
</div>

<hr />
<h4 class="mt-4">Associated Amenities</h4>

<div class="card shadow-sm">
    <div class="card-body">
        @if (Model.ReservationAmenities != null && Model.ReservationAmenities.Any())
        {
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Amenity</th>
                        <th class="text-center">Quantity</th>
                        <th class="text-end">Price per Unit</th>
                        <th class="text-end">Sub-total</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.ReservationAmenities)
                    {
                        <tr>
                            <td>@Html.DisplayFor(modelItem => item.Amenity.Name)</td>
                            <td class="text-center">@Html.DisplayFor(modelItem => item.Quantity)</td>
                            <td class="text-end">@item.PriceAtTimeOfBooking.ToString("C")</td>
                            <td class="text-end">@((item.Quantity * item.PriceAtTimeOfBooking).ToString("C"))</td>

                            <td class="text-end">
                                @if (User.IsInRole("Employee") || User.IsInRole("Admin"))
                                {
                                    <form asp-action="RemoveAmenityFromReservation" method="post" onsubmit="return confirm('Are you sure you want to remove this amenity?');">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="reservationId" value="@Model.Id" />
                                        <input type="hidden" name="reservationAmenityId" value="@item.Id" />
                                        <button type="submit" class="btn btn-danger btn-sm" title="Remove">
                                            <i class="fas fa-trash-alt"></i> @* Ícone de lixo (Font Awesome) *@
                                        </button>
                                    </form>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" class="text-end fw-bold">Amenities Total:</td>
                        <td class="text-end fw-bold">
                            @Model.ReservationAmenities.Sum(a => a.Quantity * a.PriceAtTimeOfBooking).ToString("C")
                        </td>
                    </tr>
                </tfoot>
            </table>
        }
        else
        {
            <p class="mb-0">No amenities have been added to this reservation yet.</p>
        }

        @if (User.IsInRole("Employee") || User.IsInRole("Admin"))
        {
            <hr />
            <h5>Add a New Amenity</h5>
            <form asp-action="AddAmenityToReservation" method="post" class="row gx-3 gy-2 align-items-center">
                @Html.AntiForgeryToken()

                @* Campo escondido para enviar o ID da reserva atual *@
                <input type="hidden" name="reservationId" value="@Model.Id" />

                <div class="col-sm-5">
                    <label class="visually-hidden" for="amenityId">Amenity</label>
                    @* A lista dropdown será populada pelo ViewBag que vamos criar no controlador *@
                    <select name="amenityId" class="form-select" asp-items="ViewBag.Amenities"></select>
                </div>

                <div class="col-sm-3">
                    <label class="visually-hidden" for="quantity">Quantity</label>
                    <input type="number" name="quantity" class="form-control" value="1" min="1" />
                </div>

                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </form>
        }
    </div>
</div>

<div class="mt-3">
    @if (User.IsInRole("Employee"))
    {
        <a asp-action="Index" class="btn btn-secondary">Back to Reservations List</a>
    }
    else if (User.IsInRole("Guest"))
    {
        <a asp-action="MyReservations" class="btn btn-secondary">Back to My Reservations</a>
    }
</div>


