@model HotelWebApp.Models.ReservationViewModel
@using HotelWebApp.Data.Entities

@{
    ViewData["Title"] = "New Reservation";
}

<h1>@ViewData["Title"]</h1>
<hr />

<div class="row">
    <div class="col-md-6">
        <h4>Check Availability</h4>
        <form action="/Reservations/Create" method="get" class="mb-4">

            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            @if (Model.RoomId > 0)
            {
                <input type="hidden" name="roomId" value="@Model.RoomId" />
            }

            @if (ViewBag.Source != null)
            {
                <input type="hidden" name="source" value="@ViewBag.Source" />
            }

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="checkInDate" class="control-label">Check-in Date</label>
                    <input name="checkInDate" id="checkInDate" type="date" class="form-control"
                           value="@Model.CheckInDate.ToString("yyyy-MM-dd")" />

                    <span asp-validation-for="CheckInDate" class="text-danger"></span>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="checkOutDate" class="control-label">Check-out Date</label>
                    <input name="checkOutDate" id="checkOutDate" type="date" class="form-control"
                           value="@Model.CheckOutDate.ToString("yyyy-MM-dd")" />

                    <span asp-validation-for="CheckOutDate" class="text-danger"></span>
                </div>
            </div>
            <button type="submit" class="btn btn-info mt-3">Find Available Rooms</button>
        </form>

        @if (ViewBag.TriedSearch == true)
        {
            @if (Model.Rooms != null && Model.Rooms.Any())
            {
                <h4>Complete Your Reservation</h4>
                <form asp-action="Create" method="post">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                    <input type="hidden" asp-for="CheckInDate" />
                    <input type="hidden" asp-for="CheckOutDate" />
                    <input type="hidden" asp-for="Source" />

                    @if (User.IsInRole("Employee"))
                    {
                        <div class="form-group mb-3">
                            <label asp-for="GuestId" class="control-label"></label>
                            <select asp-for="GuestId" class="form-control" asp-items="Model.Guests" required>
                                <option value="">-- Select a Guest --</option>
                            </select>
                        </div>
                    }

                    @if (Model.RoomId > 0 && Model.Rooms.Any())
                    {
                        <div class="form-group mb-3">
                            <label class="control-label">Room</label>
                            <input type="text" class="form-control" value="@Model.Rooms.First().Text" readonly />
                            <input type="hidden" asp-for="RoomId" />
                        </div>
                    }
                    else
                    {
                        <div class="form-group mb-3">
                            <label asp-for="RoomId" class="control-label">Available Rooms</label>
                            <select asp-for="RoomId" class="form-control" asp-items="Model.Rooms" required>
                                <option value="">-- Select a Room --</option>
                            </select>
                        </div>
                    }

                    <div class="form-group mb-3">
                        <label asp-for="NumberOfGuests" class="control-label"></label>
                        <input asp-for="NumberOfGuests" type="number" class="form-control" value="1" min="1" required />
                        <span asp-validation-for="NumberOfGuests" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <input type="submit" value="Confirm Reservation" class="btn btn-primary" />
                    </div>
                </form>
            }
            else
            {
                <div class="alert alert-warning mt-4">
                    No rooms available for the selected dates. Please try another period.
                </div>
            }
        }
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const checkInInput = document.getElementById('checkInDate');
            const checkOutInput = document.getElementById('checkOutDate');

             function updateCheckOutConstraints() {
                if (!checkInInput.value) {
                    return;
                }

                let checkInDate = new Date(checkInInput.value);
                let minCheckOutDate = new Date(checkInDate.setDate(checkInDate.getDate() + 1));

                let minDateString = minCheckOutDate.toISOString().split('T')[0];

                checkOutInput.min = minDateString;

                if (checkOutInput.value < minDateString) {
                    checkOutInput.value = minDateString;
                }
            }


            checkInInput.addEventListener('change', updateCheckOutConstraints);

            updateCheckOutConstraints();
        });
    </script>
}
