@model HotelWebApp.Models.ReservationViewModel
@using HotelWebApp.Data.Entities

@{
    ViewData["Title"] = "New Reservation";
}

<h1>@ViewData["Title"]</h1>
<hr />

<div class="row">
    <div class="col-md-6">
        <!-- PASSO 1: Formulário para selecionar as datas -->
        <h4>Step 1: Check Availability</h4>
        <form action="/Reservations/Create" method="get" class="mb-4">

            @* Adicione um ValidationSummary para erros gerais.
       A sua Action POST já tem um, mas é bom ter aqui também. *@
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            @* Se um RoomId já existe, passa-o para a frente *@
            @if (Model.RoomId > 0)
            {
                <input type="hidden" name="roomId" value="@Model.RoomId" />
            }

            @* Se um source já existe, passa-o para a frente *@
            @if (ViewBag.Source != null)
            {
                <input type="hidden" name="source" value="@ViewBag.Source" />
            }

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="checkInDate" class="control-label">Check-in Date</label>
                    <input name="checkInDate" id="checkInDate" type="date" class="form-control"
                           value="@Model.CheckInDate.ToString("yyyy-MM-dd")" />

                    @* Local para mostrar erros específicos do CheckInDate *@
                    <span asp-validation-for="CheckInDate" class="text-danger"></span>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="checkOutDate" class="control-label">Check-out Date</label>
                    <input name="checkOutDate" id="checkOutDate" type="date" class="form-control"
                           value="@Model.CheckOutDate.ToString("yyyy-MM-dd")" />

                    @* Local para mostrar o erro "Check-out date must be after..." *@
                    <span asp-validation-for="CheckOutDate" class="text-danger"></span>
                </div>
            </div>
            <button type="submit" class="btn btn-info mt-3">Find Available Rooms</button>
        </form>

        <!-- PASSO 2: Formulário para completar a reserva (só aparece após a pesquisa) -->
        @if (Model.Rooms != null && Model.Rooms.Any())
        {
            // Se a pesquisa encontrou quartos, mostra o formulário completo
            <h4>Step 2: Complete Your Reservation</h4>
            <form asp-action="Create" method="post">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                @* Passar as datas e o source escolhidos para o POST *@
                <input type="hidden" asp-for="CheckInDate" />
                <input type="hidden" asp-for="CheckOutDate" />
                <input type="hidden" asp-for="Source" />

                @if (User.IsInRole("Employee"))
                {
                    <div class="form-group mb-3">
                        <label asp-for="GuestId" class="control-label"></label>
                        <select asp-for="GuestId" class="form-control" asp-items="Model.Guests" required>
                            <option value="">-- Select a Guest --</option>
                        </select>
                    </div>
                }

                @if (Model.RoomId > 0 && Model.Rooms.Any())
                {
                    <div class="form-group mb-3">
                        <label class="control-label">Room</label>
                        <input type="text" class="form-control" value="@Model.Rooms.First().Text" readonly />
                        <input type="hidden" asp-for="RoomId" />
                    </div>
                }
                else
                {
                    <div class="form-group mb-3">
                        <label asp-for="RoomId" class="control-label">Available Rooms</label>
                        <select asp-for="RoomId" class="form-control" asp-items="Model.Rooms" required>
                            <option value="">-- Select a Room --</option>
                        </select>
                    </div>
                }

                <div class="form-group mb-3">
                    <label asp-for="NumberOfGuests" class="control-label"></label>
                    <input asp-for="NumberOfGuests" type="number" class="form-control" value="1" min="1" required />
                    <span asp-validation-for="NumberOfGuests" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <input type="submit" value="Confirm Reservation" class="btn btn-primary" />
                </div>
            </form>
        }
        else if (ViewBag.TriedSearch == true)
        {
            // Senão, se o utilizador já pesquisou mas não encontrou quartos, mostra apenas a mensagem
            <div class="alert alert-warning mt-4">
                No rooms available for the selected dates. Please try another period.
            </div>
        }
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}